<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Battleship client</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
    }

    .hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      margin: 8px 0;
    }

    td {
      width: 28px;
      height: 28px;
      text-align: center;
      border: 1px solid #666;
      cursor: pointer;
    }

    .sea {
      background: #cfefff;
    }

    .ship {
      background: #999;
      color: #fff;
    }

    .hit {
      background: #f33;
      color: #fff;
    }

    .miss {
      background: #ddd;
    }
  </style>
</head>

<body>
  <div id="joinView">
    <h1>Battleship</h1>
    <button id="refreshServerListButton">Refresh server list</button>
    <div id="serverSelect" class="server-select">
    </div>
    <br>
    <div>
      <label for="player_name">Optionally, enter a name to save your statistics</label>
      <input type="text" id="playerNameInput" name="player_name" minlength="3" maxlength="20"></input>
    </div>
    <br>
    <button id="joinBtn">Join Game</button>
    <p id="joinMsg"></p>
    <p>Click here to show the statistics table of the selected server.</p>
    <button id="statisticsButton">Statistics</button>
    <div id="statisticsTable">
    </div>
    <p id="statisticsErrorMsg"></p>
  </div>



  <div id="startView" class="hidden">
    <h1>Battleship</h1>
    <button id="startBtn">Start New Game</button>
    <p id="startMsg"></p>
  </div>

  <div id="gameView" class="hidden">
    <h2 id="player">You are player X</h2>
    <h2 id="status">It is player Y's turn</h2>
    <div style="display:flex; gap:32px;">
      <div>
        <h3>Your grid</h3>
        <div id="ownGrid"></div>
      </div>
      <div>
        <h3>Opponent (click to fire)</h3>
        <div id="oppGrid"></div>
      </div>
    </div>
    <p id="lastResult"></p>
    <button id="backToStart">Quit</button>
  </div>

  <div id="endView" class="hidden">
    <h1 id="winnerMsg"></h1>
    <button id="playAgain">Play Again</button>
  </div>



  <script>
    async function api(path, method = 'GET', body = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(path, opts);
      return res.json();
    }

    const refreshServerListButton = document.getElementById('refreshServerListButton');
    const joinBtn = document.getElementById('joinBtn');
    const playerNameInput = document.getElementById('playerNameInput');
    const statisticsButton = document.getElementById('statisticsButton');
    const statisticsErrorMsg = document.getElementById('statisticsErrorMsg');
    const joinMsg = document.getElementById('joinMsg');
    const startBtn = document.getElementById('startBtn');
    const startMsg = document.getElementById('startMsg');
    const gameView = document.getElementById('gameView');
    const startView = document.getElementById('startView');
    const endView = document.getElementById('endView');
    const playerEl = document.getElementById('player');
    const statusEl = document.getElementById('status');
    const oppGridEl = document.getElementById('oppGrid');
    const ownGridEl = document.getElementById('ownGrid');
    const lastResult = document.getElementById('lastResult');
    const backToStart = document.getElementById('backToStart');
    const playAgain = document.getElementById('playAgain');
    let state = null;
    let refreshInterval = null;

    function renderGrid(container, grid, clickable = false, onClickCell = null, hideShips = false) {
      container.innerHTML = '';
      const table = document.createElement('table');
      grid.forEach((row, r) => {
        const tr = document.createElement('tr');
        row.forEach((cell, c) => {
          const td = document.createElement('td');
          td.className = 'sea';
          let display = cell;
          if (cell === '~') display = '';
          if (cell === 'S') {
            if (hideShips) { display = ''; td.className = 'sea'; }
            else { td.className = 'ship'; display = 'S'; }
          }
          if (cell === 'X') { td.className = 'hit'; display = 'X'; }
          if (cell === 'O') { td.className = 'miss'; display = 'O'; }

          td.textContent = display;
          if (clickable) {
            td.addEventListener('click', () => onClickCell && onClickCell(r, c));
          } else {
            td.style.cursor = 'default';
          }
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      container.appendChild(table);
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function setCookie(name, value) {
      document.cookie = `${name}=${value}; path=/`;
    }

    async function refreshState() {
      try {
        const json = await api('/api/state');
        state = json;
        if (state.error) { startMsg.textContent = state.error; return; }
        const me = Number(getCookie("player_id"));
        playerEl.textContent = `Player ${me}`;
        statusEl.textContent = state.winner ? 'Game over' : `${state.current_player == me ? 'Your' : 'Opponent\'s'} turn`;
        lastResult.textContent = '';
        let ownGrid, oppTracking;
        if (me === 1) {
          ownGrid = state.p1_grid;
          oppTracking = state.p1_tracking;
        } else {
          ownGrid = state.p2_grid;
          oppTracking = state.p2_tracking;
        }
        renderGrid(ownGridEl, ownGrid, false, null, false);
        renderGrid(oppGridEl, oppTracking, state.winner ? false : true, onFireClick, true);

        if (state.winner) {
          startView.classList.add('hidden');
          gameView.classList.add('hidden');
          endView.classList.remove('hidden');
          document.getElementById('winnerMsg').textContent = `Player ${state.winner} wins!`;
          clearInterval(refreshInterval);
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function onFireClick(r, c) {
      try {
        const res = await api('/api/fire', 'POST', { row: r, col: c });
        if (res.error) {
          lastResult.textContent = res.error;
        } else {
          lastResult.textContent = res.result + (res.winner ? ` — Player ${res.winner} wins!` : '');
          await refreshState();
        }
      } catch (e) { lastResult.textContent = 'Network error'; }
    }

    async function loadServers() {
      try {
        // get configured servers
        const cfg = await fetch('/api/config').then(r => r.json());
        if (cfg.error) { console.warn(cfg); return; }
        const servers = cfg.servers || [];

        // ping all servers (fast timeout on server-side)
        const pingRes = await fetch('/api/ping_all').then(r => r.json());
        const statusByServer = {};
        if (Array.isArray(pingRes)) {
          pingRes.forEach(p => { statusByServer[p.server] = p; });
        }

        // build select UI inside #serverSelect
        const container = document.getElementById('serverSelect');
        container.innerHTML = '';
        const sel = document.createElement('select');
        sel.id = 'server';
        sel.style.minWidth = '320px';
        servers.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          const st = statusByServer[s];
          const label = st ? (st.ok ? `${s} — OK` : `${s} — DOWN`) : s;
          opt.textContent = label;
          sel.appendChild(opt);
        });
        if (cfg.default) sel.value = cfg.default;
        container.appendChild(sel);

        // small status summary
        const summary = document.createElement('div');
        summary.style.marginTop = '8px';
        summary.textContent = `Checked ${servers.length} server(s).`;
        container.appendChild(summary);

      } catch (err) {
        console.warn('loadServers error', err);
      }
    }
    loadServers();

    refreshServerListButton.addEventListener('click', async () => {
      refreshServerListButton.textContent = 'Refreshing server list...';
      await loadServers();
      refreshServerListButton.textContent = 'Refresh server list';
    });

    joinBtn.addEventListener('click', async () => {
      joinBtn.textContent = 'Joining...';
      setCookie('server_url', document.getElementById('server').value);
      const res = await api('/api/join', 'POST', { "playerName": playerNameInput.value });
      if (res) {
        joinView.classList.add('hidden');
        startView.classList.remove('hidden');
      } else {
        joinMsg.textContent = 'Failed to join game';
      }
    });

    statisticsButton.addEventListener('click', async () => {
      setCookie('server_url', document.getElementById('server').value);
      const res = await api('/api/statistics', 'GET');
      if (!res.error) {
        statisticsErrorMsg.textContent = ""
        const tableDiv = document.getElementById("statisticsTable")
        tableDiv.innerHTML = "";

        const titleTr = document.createElement("tr")
        const titleTd1 = document.createElement("td")
        const titleTd2 = document.createElement("td")
        const titleTd3 = document.createElement("td")
        titleTd1.innerHTML = "Name"
        titleTd2.innerHTML = "Games Won"
        titleTd3.innerHTML = "Games Lost"
        titleTr.appendChild(titleTd1)
        titleTr.appendChild(titleTd2)
        titleTr.appendChild(titleTd3)
        tableDiv.appendChild(titleTr)

        res.forEach(item => {
          const tr = document.createElement("tr")
          const player_name_td = document.createElement("td")
          player_name_td.innerHTML = item["player_name"]
          const games_won_td = document.createElement("td")
          games_won_td.innerHTML = item["games_won"]
          const games_lost_td = document.createElement("td")
          games_lost_td.innerHTML = item["games_lost"]
          tr.appendChild(player_name_td)
          tr.appendChild(games_won_td)
          tr.appendChild(games_lost_td)
          tableDiv.appendChild(tr)
        })
      } else {
        statisticsErrorMsg.textContent = "Failed to get statistics!"
      }
    })

    startBtn.addEventListener('click', async () => {
      startMsg.textContent = 'Starting...';
      const res = await api('/api/start', 'POST', {});
      if (res && res === true || res && res.ok) {
        startView.classList.add('hidden');
        endView.classList.add('hidden');
        gameView.classList.remove('hidden');
        await refreshState();
        refreshInterval = setInterval(refreshState, 2000);
      } else {
        startMsg.textContent = 'Failed to start';
      }
    });

    backToStart.addEventListener('click', () => {
      location.reload();
    });
    playAgain.addEventListener('click', () => location.reload());
  </script>
</body>

</html>